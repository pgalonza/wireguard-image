---
- name: Install WireGuard
  hosts: vds
  become: yes
  vars:
    ug_id: 1050
    network_mode: wireguard
  vars_files:
    - "{{ lookup('env', 'ANSIBLE_VARIABLES') }}"
  tasks:
    - name: Add wireguard to firewall service
      ansible.builtin.copy:
        src: ./files/wireguard.xml
        dest: /etc/firewalld/services/wireguard.xml
        mode: '0644'
      notify:
        - reload_firewalld
        - enable_wireguard
    - name: Add wireguard dashboard to firewall service
      ansible.builtin.copy:
        src: ./files/wgdashboard.xml
        dest: /etc/firewalld/services/wgdashboard.xml
        mode: '0644'
      notify:
        - reload_firewalld
        - enable_wgdashboard
    - name: Add WireGuard service user
      ansible.builtin.user:
        name: wireguard
        comment: WireGuard service user
        uid: "{{ ug_id }}"
    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /home/wireguard/config
        state: directory
        mode: '0755'
        owner: wireguard
        group: wireguard
    - name: Install podman
      dnf:
        name: podman-3.3.1
        state: present
    - name: Stop and Remove WireGuard container
      containers.podman.podman_container:
        name: wireguard
        state: absent
    - name: Remove an WireGuard image
      containers.podman.podman_image:
        name: "registry.gitlab.com/pgalonza/wireguard-image:{{ image_tag }}"
        state: absent
    - name: Adding container network
      containers.podman.podman_network:
        name: wireguard
        ipv6: yes
        subnet: 'fc00:bfb7:3bdb:ae34::/64'
    - name: Pull a WireGuard latest image
      containers.podman.podman_image:
        name: registry.gitlab.com/pgalonza/wireguard-image
        tag: "{{ image_tag }}"
    - name: Run WireGuard container
      containers.podman.podman_container:
        name: wireguard
        image: "registry.gitlab.com/pgalonza/wireguard-image:{{ image_tag }}"
        state: started
        sysctl:
          net.ipv4.conf.all.src_valid_mark: 1
        privileged: yes
        volume:
          - /home/wireguard/config:/config
          - /lib/modules:/lib/modules
          - /usr/src/kernels:/usr/src/kernels
        ports:
          - "51820:51820/udp"
          - "10086:10086/tcp"
        network: "{{ network_mode }}"
        env:
          PUID: "{{ ug_id }}"
          PGID: "{{ ug_id }}"
          SERVERURL: "{{ vpn_urls[groups['vds'].index(inventory_hostname)] }}"
          PEERS: "{{ peers_count }}"

  handlers:
    - name: Restart firewalld service
      command: firewall-cmd --reload
      listen: reload_firewalld
    - name: Enable wireguard service
      ansible.posix.firewalld:
        zone: public
        service: wireguard
        permanent: yes
        state: enabled
        immediate: yes
    - name: Enable wireguard dashboard service
      ansible.posix.firewalld:
        zone: public
        service: wgdashboard
        permanent: yes
        state: enabled
        immediate: yes
      listen: enable_wgdashboard
...
